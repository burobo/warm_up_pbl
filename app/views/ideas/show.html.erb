<div class="container">
  <div class="mt-5 mx-5">
    <p>
      発案者：<%= @idea.user.name %>
    </p>
    <h1 class="mb-4">
      <%= @idea.title %>
    </h1>
    <h2 class="mb-5">
      <%= @idea.outline %>
    </h2>

    <!-- 詳細 -->
    <div id = "detail" class="mb-4"></div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <% if current_user !=nil && (@idea.user_id==current_user.id || @idea.users.find_by_id(current_user.id) !=nil) %>
      <script>
        document.getElementById('detail').innerHTML =  marked.parse('<%= @idea.detail.gsub(/\R/, "\\n")%>');
      </script>
    <% else %>
      <script>
        document.getElementById('detail').remove();
      </script>
      <p>※イイねすると詳細を閲覧できます</p>
    <% end %>

    <div class="d-flex align-items-center">
      <div class="d-flex me-2">
        <%= form_with model: @idea, url: "#{@idea.id}/favorite" , local: true, id: @idea.id, method: :put do |f| %>
          <%= f.hidden_field :'id', :value=> @idea.id %>
            <% if current_user==nil %>
              <%= button_tag type: 'submit' , class: 'unlike me-1' do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart"
                  viewBox="0 0 16 16">
                  <path
                    d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z" />
                </svg>
                <% end %>
            <% elsif @idea.user_id==current_user.id %>
            <% elsif @idea.users.find_by_id(current_user.id)==nil %>
              <%= button_tag type: 'submit' , class: 'unlike me-1' do %>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-heart" viewBox="0 0 16 16">
                <path
                  d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z" />
              </svg>
              <% end %>
            <% else %>
              <%= button_tag type: 'submit' , class: 'like me-1' do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                  class="bi bi-heart" viewBox="0 0 16 16">
                  <path
                    d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z" />
                </svg>
              <% end %>
            <% end %>
          <% end %>
        <%= @idea.favorites.size %>
      </div>
      <div>
        イイねした人:
        <% @idea.users.each do |user| %>
          <%= user.name %>
            <% end %>
      </div>
    </div>
    
    <div class="text-start">
      <%= link_to 'Back' , root_path %>
    </div>
    <div class="text-start">
      <%= link_to '編集' , ideas_edit_path(@idea.id) %>
    </div>
    <div>
      <div>
        <% @idea.comments.each do |comment| %>
          <div class="card my-3">
            <div class="card-body">
              <div class="row p-2 border-bottom">
                <div class="col-1 text-start">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-emoji-smile" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M4.285 9.567a.5.5 0 0 1 .683.183A3.498 3.498 0 0 0 8 11.5a3.498 3.498 0 0 0 3.032-1.75.5.5 0 1 1 .866.5A4.498 4.498 0 0 1 8 12.5a4.498 4.498 0 0 1-3.898-2.25.5.5 0 0 1 .183-.683zM7 6.5C7 7.328 6.552 8 6 8s-1-.672-1-1.5S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5S9.448 5 10 5s1 .672 1 1.5z"/>
                  </svg>
                </div>
                <div class="col-8 text-start">
                  <%= comment.user.name %>
                </div>
                <p class="card-text ps-3 col-3">
                  <% if (Time.now.to_i - comment.created_at.to_i) <= 60 * 60 %>
                  <%= (Time.now.to_i - comment.created_at.to_i) / 60 %>
                  分前
                  <% elsif (Time.now.to_i - comment.created_at.to_i) <= 60 * 60 * 24 %>
                  <%= (Time.now.to_i - comment.created_at.to_i) / 60 / 60 %>
                  時間前
                  <% else %>
                  <%= (Time.now.to_i - comment.created_at.to_i) / 60 / 60 / 24 %>
                  日前
                  <% end %>
                </p>
              </div>
              <div class="row m-2">
                <div class="col-1">
                </div>
                <div class="col-11 text-start">
                  <%= comment.content %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
        <div class="card border-0 my-3">
          <%= form_with model: [@idea, @comment], url: ideas_show_comments_path(@idea.id), method: :post do |f| %>
            <div class="form-group">
              <%= f.text_area :content, class: "form-control", placeholder: "コメントを入力", rows: "6" %>
              <%= f.hidden_field :idea_id, value: @idea.id %>
            </div>
            <div class="text-end mt-2">
              <%= f.submit "投稿する", class: "w-25 btn btn-primary", disable_with: '投稿中...' %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>